<!DOCTYPE html>
<html lang="pt-br" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>CRUD de cliente</title>
        <link rel="stylesheet" href="/CSS/styles.css">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
		<link rel="icon" href="/Images/favicon.ico" type="image/x-icon">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha384-KyZXEAg3QhqLMpG8r+Knujsl5/6f5xX5L0d7/1XshTLF5j8l2/zg7L2Dd6fR5Jp4C" crossorigin="anonymous"></script>
	</head>
    <body>
		<nav class="navbar navbar-custom fixed-top">
			<div class="container-fluid">
				<div class="navbar-header">
					<a id="upper-navbar-text" class="navbar-brand">CRUD DE CLIENTE</a>
				</div>

				<ul class="navbar-nav">
					<li class="nav-item">
						<a class="btn btn-default" id="add-client-button" href="createClient">Adicionar cliente</a>
					</li>
				</ul>

			</div>
		</nav>

		<div class="container mt-5">
			<div style="max-width: 1200px; margin: 0 auto">
				<table class="table table-striped table-hover">
					<thead class="table-dark">
						<tr>
							<th>ID</th>
							<th>Nome completo</th>
							<th>Senha</th>
							<th>Gênero</th>
							<th>Data de nascimento</th>
							<th>CPF</th>
							<th>Email</th>
							<th>Endereços</th>
							<th>Telefone</th>
							<th>Ativo</th>
							<th>Ações</th>

						</tr>
					</thead>
					<tbody>
						<tr th:each="client : ${clients}">
							<td th:text = "${client.id}"></td>
							<td th:text = "${client.name}"></td>
							<td th:text = "${client.password}"></td>
							<td th:text = "${client.gender.genderType}"></td>
							<td th:text = "${#temporals.format(client.birthday, 'dd-MM-yyyy')}"></td>
							<td th:text = "${client.cpf}"></td>
							<td th:text = "${client.email}"></td>
							<td>
								<button type="button" class="btn btn-secondary" th:data-bs-client-id = "${client.id}" data-bs-toggle="modal" data-bs-target="#seeAddressModal" >Ver endereços</button>
							</td>
							<td th:text = "${client.phone.phoneNumber}"></td>
							<td>
								<input type="checkbox" th:checked="${client.enabled}" disabled>
							</td>


							<td>
								<!--<a class="btn btn-primary" th:href="@{updateClient/{id}(id=${client.id})}">Atualizar</a>-->

								<form th:action="@{/deleteClient/{id}(id=${client.id})}" method="POST" style="display: inline;">
									<input type="hidden" name="_method" value="DELETE"/>
									<button type="submit" class="btn btn-danger btn-delete" onclick="return confirm('Tem certeza?')">Deletar</button>
								</form>
							</td>

						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<div id="seeAddressModal" class="modal fade">

			<div class="modal-dialog">

				<div class="modal-content">

					<div class="modal-header">

						<h3 class="modal-title">Ver endereços</h3>
						<button type="button" class="btn btn-close" data-bs-dismiss="modal"></button>

					</div>

					<div class="modal-body">

						<div>
							<h1 id="clientId"></h1>

							<button type="button" class="btn btn-success"
							data-bs-toggle="offcanvas" data-bs-target="#addressFormCanvas" aria-controls="addressFormCanvas" id="addAddressButton">
								Adicionar endereço
							</button>

							<div class="card mt-3">
								<div class="card-body">
									<h2 class="card-title">Endereços de entrega</h2>
									<div id="deliveryAddressList">

									</div>
								</div>
							</div>

							<div class="card mt-3">
								<div class="card-body">
									<h2 class="card-title">Endereços de cobrança</h2>
									<div id="chargingAddressList">

									</div>
								</div>
							</div>

						</div>

					</div>

					<div class="modal-footer">
						<button type="button" class="btn btn-danger" data-bs-dismiss="modal">Fechar</button>
					</div>

				</div>

			</div>

		</div>

                <div class="offcanvas offcanvas-start" tabindex="-1" id="addressFormCanvas" aria-labelledby="addressFormCanvasLabel">
                    <div class="offcanvas-header">
                        <h5 id="addressFormCanvasLabel">Form de endereço</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                    </div>

                    <div class="offcanvas-body">
						<!--th:object="${clientAddressDTO}" method="POST"-->
						<form id="addressForm">
							<input type="hidden" id="address-id" value=""> <!-- For updates -->
							<input type="hidden" id="client-id" value="{{clientId}}"> <!-- For both POST and PUT -->
							<div>
                                <label><b>Tipo</b></label>
                                <div class="radio-group" id="addressType">
									<label><input type="radio" name="addressTypeInput" value="false" checked> Entrega</label>
									<label><input type="radio" name="addressTypeInput" value="true"/> Cobrança</label>
                                </div>
                            </div>

                            <div>
                                <label><b>Apelido</b></label>
                                <input type="text" class="form-control" placeholder="Digite o apelido" id="addressNicknameField" required>
                            </div>

                            <div>
                                <label><b>Tipo de Residência</b></label>
                                <input type="text" class="form-control" placeholder="(Casa, apartamento, etc...)" id="addressTypeOfResidenceField" required>
                            </div>

                            <div>
                                <label><b>Tipo de logradouro</b></label>
                                <input type="text" class="form-control" placeholder="(Rua, Avenida, etc...)" id="addressAddressingTypeField" required>
                            </div>

                            <div>
                                <label><b>Logradouro</b></label>
                                <input type="text" class="form-control" placeholder="Insira o logradouro" id="addressAddressingField" required>
                            </div>

                            <div>
                                <label><b>Nº de residência</b></label>
                                <input type="text" class="form-control" placeholder="Insira o número da residência" id="addressHouseNumberField" maxlength="5" required>
                            </div>

                            <div>
                                <label><b>CEP</b></label>
                                <input type="text" class="form-control" placeholder="00000-000" id="addressCepField" maxlength="9" required>
                            </div>

                            <div>
                                <label><b>Bairro</b></label>
                                <input type="text" class="form-control" placeholder="Insira o bairro" id="addressNeighbourhoodField" required>
                            </div>

                            <div>
                                <label><b>Cidade</b></label>
                                <input type="text" class="form-control" placeholder="Insira a cidade" id="addressCityField" required>
                            </div>

                            <div>
                                <label><b>Estado</b></label>
                                <input type="text" class="form-control" placeholder="Insira o Estado" id="addressStateField" required>
                            </div>

                            <div>
                                <label><b>País</b></label>
                                <input type="text" class="form-control" placeholder="Insira o País" id="addressCountryField" required>
                            </div>

                            <div>
                                <label><b>Observação</b></label>
                                <input type="text" class="form-control" placeholder="Insira uma observação (opcional)" id="addressObservationField">
                            </div>

							<div class="mt-2">
								<button type="submit" class="btn btn-primary" id="addressFormSubmitButton">Criar</button>
							</div>

                        </form>
                    </div>
				</div>

		<script>

			const seeAddressModal = document.getElementById("seeAddressModal");
			const addAddressButton = document.getElementById("addAddressButton");

			seeAddressModal.addEventListener('show.bs.modal', function (event) {
				const button = event.relatedTarget

				const clientId = button.getAttribute('data-bs-client-id');

				const elementWithId = document.getElementById('clientId');
				elementWithId.textContent = 'ID do cliente: '
				elementWithId.textContent = elementWithId.textContent + " " + clientId;

				addAddressButton.setAttribute('data-bs-client-id', clientId);

				fetch(`index/${clientId}/addresses`)
						.then(response => {
							if(!response.ok) {
								throw new Error("Erro ao retornar endereços.");
							}
							return response.json();
						})
						.then(addresses => {
							const deliveryAddressList = document.getElementById('deliveryAddressList');
							const chargingAddressList = document.getElementById('chargingAddressList');
							let deliveryAddresses = '';
							let chargingAddresses = '';
							let addressCollapseCardId = 1;
								addresses.forEach(address => {
									const addressItem = `
														<div class="card mt-3">
															<div class="card-body">
																<h3 class="card-title">ID: ${address.id}</h3>
																<h4>${address.nickname}</h4>
																<button class="btn" data-bs-toggle="collapse" data-bs-target="#addressCollapseCardId_${addressCollapseCardId}">
																	<i class="bi bi-chevron-down"></i>
																</button>
																<div id="addressCollapseCardId_${addressCollapseCardId}" class="collapse">
																	<p>Tipo de residência: ${address.typeOfResidence}</p>
																	<p>Logradouro: ${address.addressing}</p>
																	<p>Número: ${address.houseNumber}</p>
																	<p>Bairro: ${address.neighbourhood}</p>
																	<p>Tipo de logradouro: ${address.addressingType}</p>
																	<p>CEP: ${address.cep}</p>
																	<p>Cidade: ${address.city}</p>
																	<p>Estado: ${address.state}</p>
																	<p>País: ${address.country}</p>
																	<p>Observação: ${address.observation}</p>

																	<form action="index/${address.id}/addresses/delete" method="POST" style="display: inline;">
																		<input type="hidden" name="_method" value="DELETE"/>
																		<button type="submit" class="btn btn-danger btn-delete" onclick="return confirm('Tem certeza?')">Deletar</button>
																	</form>

																	<!--
																		data-bs-address-id= "${address.id}"
																		data-bs-address-addressType="${address.addressType}"
																		data-bs-address-nickname="${address.nickname}"
																		data-bs-address-typeOfResidence="${address.typeOfResidence}"
																		data-bs-address-addressing="${address.addressing}"
																		data-bs-address-houseNumber="${address.houseNumber}"
																		data-bs-address-neighbourhood="${address.neighbourhood}"
																		data-bs-address-addressingType="${address.addressingType}"
																		data-bs-address-cep="${address.cep}"
																		data-bs-address-city="${address.city}"
																		data-bs-address-state="${address.state}"
																		data-bs-address-country="${address.country}"
																		data-bs-address-observation="${address.observation}"

																	-->

																	<form action="index/addresses/${address.id}" method="GET" style="display: inline;">
																		<button type="button" class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#addressFormCanvas"
																		aria-controls="addressFormCanvas" id="updateAddressButton" data-bs-address-id= "${address.id}"
																		data-bs-client-id="${clientId}">
																		Atualizar</button>
																	</form>

																</div>
															</div>
														</div>`;
									addressCollapseCardId += 1;
									if(address.addressType == false) {
										deliveryAddresses += addressItem;
									} else {
										chargingAddresses += addressItem;
									}
								});
								deliveryAddressList.innerHTML = deliveryAddresses;
								chargingAddressList.innerHTML = chargingAddresses;
							})
			});

			const addressOffcanvas = document.getElementById("addressFormCanvas");

			addressOffcanvas.addEventListener('show.bs.offcanvas', function(event) {
				button = event.relatedTarget;
				const addressIdFromGetUpdate = button.getAttribute('data-bs-address-id');
				const addressForm = document.getElementById("addressForm");
				const addressFormMethod = document.getElementById("addressFormMethod");

				const addressFormCanvasLabel = document.getElementById('addressFormCanvasLabel');

				const nicknameField = document.getElementById("addressNicknameField");
				const typeOfResidenceField = document.getElementById("addressTypeOfResidenceField");
				const addressingTypeField = document.getElementById("addressAddressingTypeField");
				const addressingField = document.getElementById("addressAddressingField")
				const houseNumberField = document.getElementById("addressHouseNumberField")
				const neighbourhoodField = document.getElementById("addressNeighbourhoodField")
				const cepField = document.getElementById("addressCepField")
				const cityField = document.getElementById("addressCityField")
				const stateField = document.getElementById("addressStateField")
				const countryField = document.getElementById("addressCountryField")
				const observationField = document.getElementById("addressObservationField")

				const addressTypeInputs = document.getElementsByName('addressTypeInput')

				const addressFormSubmitButton = document.getElementById("addressFormSubmitButton")

				const addressId = document.getElementById('address-id').value; // Hidden input for address ID
				const clientId = document.getElementById('client-id').value; // Client ID
				const addressDTO = {
					addressType: addressTypeField.value,
					nickname: nicknameField.value,
					typeOfResidence: typeOfResidenceField.value,
					addressingType: addressingTypeField.value,
					addressing: addressingField.value,
					houseNumber: houseNumberField.value,
					neighbourhood: neighbourhoodField.value,
					cep: cepField.value,
					city: cityField.value,
					state: stateField.value,
					country: countryField.value,
					observation: observationField.value
				};

				let method, url;

				if (addressId) {
					// Update existing address (PUT)
					method = 'PUT';
					url = `/index/${clientId}/addresses/${addressId}/update`;
				} else {
					// Create new address (POST)
					method = 'POST';
					url = `/index/clients/${clientId}/addresses/create`;
				}

				fetch(url, {
					method: method,
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(addressDTO),
				})
						.then(response => {
							if (!response.ok) {
								throw new Error('Error submitting the address');
							}
							return response.json(); // handle response if needed
						})
						.then(data => {
							console.log('Address submission successful:', data);
							// Optionally close the offcanvas or reset the form here
						})
						.catch(error => {
							console.error('Error:', error);
						});

				/*if(button.id == "updateAddressButton") {


					console.log("Update address")

					addressForm.setAttribute('action', `index/addresses/${addressId}/update`);
					addressForm.setAttribute('method', 'POST')
					addressFormMethod.value = "PUT";
					addressFormCanvasLabel.innerHTML = 'Atualizar endereço';

					const addressIdNewElement = document.createElement('h5');
					addressIdNewElement.textContent = "ID: " + addressId;
					addressIdNewElement.id = "addressIdUpdateElement"

					addressForm.insertAdjacentElement('afterbegin', addressIdNewElement);

					fetch(`index/addresses/${addressId}`)
							.then(response => {
								if (!response.ok) {
									throw new Error("Erro ao retornar endereço.");
								}
								return response.json();
							})
							.then(address => {
								const addressType = address.addressType
								const nickname = address.nickname;
								const typeOfResidence = address.typeOfResidence;
								const addressing = address.addressing;
								const houseNumber = address.houseNumber;
								const neighbourhood = address.neighbourhood;
								const addressingType = address.addressingType;
								const cep = address.cep;
								const city = address.city;
								const state = address.state;
								const country = address.country;
								const observation = address.observation;

								if(addressType == false) {
									addressTypeInputs.item(0).checked = true
								} else {
									addressTypeInputs.item(1).checked = true
								}

								nicknameField.value = nickname;
								typeOfResidenceField.value = typeOfResidence;
								addressingTypeField.value = addressingType;
								addressingField.value = addressing;
								houseNumberField.value = houseNumber;
								neighbourhoodField.value = neighbourhood;
								cepField.value = cep;
								cityField.value = city;
								stateField.value = state;
								countryField.value = country;
								observationField.value = observation;

								const addressDTO = {
									addressType: addressTypeField.value,
									nickname: nicknameField.value,
									typeOfResidence: typeOfResidenceField.value,
									addressingType: addressingTypeField.value,
									addressing: addressingField.value,
									houseNumber: houseNumberField.value,
									neighbourhood: neighbourhoodField.value,
									cep: cepField.value,
									city: cityField.value,
									state: stateField.value,
									country: countryField.value,
									observation: observationField.value
								};

								let method, url;

								if (addressId) {
									// Update existing address (PUT)
									method = 'PUT';
									url = `/index/${clientId}/addresses/${addressId}/update`;
								} else {
									// Create new address (POST)
									method = 'POST';
									url = `/index/clients/${clientId}/addresses/create`;
								}

								fetch(url, {
									method: method,
									headers: {
										'Content-Type': 'application/json',
									},
									body: JSON.stringify(addressDTO),
								})
										.then(response => {
											if (!response.ok) {
												throw new Error('Error submitting the address');
											}
											return response.json(); // handle response if needed
										})
										.then(data => {
											console.log('Address submission successful:', data);
											// Optionally close the offcanvas or reset the form here
										})
										.catch(error => {
											console.error('Error:', error);
										});

								addressFormSubmitButton.innerHTML = 'Atualizar'


							})
							.catch(error => console.error("Error:", error));

				} else if (button.id == "addAddressButton") {
					console.log("Create address")
					const clientId = addAddressButton.getAttribute('data-bs-client-id');
					addressFormMethod.setAttribute("action", `index/${clientId}/addresses/create`);
					addressForm.setAttribute("method", "POST")
					addressFormMethod.value = "POST"
					addressFormCanvasLabel.innerHTML = 'Adicionar endereço';

					const addressIdNewElement = document.getElementById("addressIdUpdateElement");

					if(addressIdNewElement) {
						addressIdNewElement.remove()
					}

					nicknameField.value = '';
					typeOfResidenceField.value = '';
					addressingTypeField.value = '';
					addressingField.value = '';
					houseNumberField.value = '';
					neighbourhoodField.value = '';
					cepField.value = '';
					cityField.value = '';
					stateField.value = '';
					countryField.value = '';
					observationField.value = '';

					addressFormSubmitButton.innerHTML = 'Criar'
				}*/

			});

		</script>

		<footer id="footer">
			<img src="/Images/figureoutlogo1.svg">
		</footer>

    </body>
</html>